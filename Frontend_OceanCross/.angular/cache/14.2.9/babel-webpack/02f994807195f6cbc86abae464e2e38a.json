{"ast":null,"code":"/**\n * This module contains some common helpers shared between middlewares\n */\n'use strict';\n\nconst mime = require('mime');\n\nconst parseRange = require('range-parser');\n\nconst log = require('../logger').create('web-server');\n\nfunction createServeFile(fs, directory, config) {\n  const cache = Object.create(null);\n  return function (filepath, rangeHeader, response, transform, content, doNotCache) {\n    let responseData;\n\n    function convertForRangeRequest() {\n      const range = parseRange(responseData.length, rangeHeader);\n\n      if (range === -2) {\n        return 200; // malformed header string\n      } else if (range === -1) {\n        responseData = Buffer.alloc(0); // unsatisfiable range\n\n        return 416;\n      } else if (range.type === 'bytes') {\n        responseData = Buffer.from(responseData);\n\n        if (range.length === 1) {\n          const {\n            start,\n            end\n          } = range[0];\n          response.setHeader('Content-Range', `bytes ${start}-${end}/${responseData.length}`);\n          response.setHeader('Accept-Ranges', 'bytes');\n          response.setHeader('Content-Length', end - start + 1);\n          responseData = responseData.slice(start, end + 1);\n          return 206;\n        } else {\n          responseData = Buffer.alloc(0); // Multiple ranges are not supported. Maybe future?\n\n          return 416;\n        }\n      }\n\n      return 200; // All other states, ignore\n    }\n\n    if (directory) {\n      filepath = directory + filepath;\n    }\n\n    if (!content && cache[filepath]) {\n      content = cache[filepath];\n    }\n\n    if (config && config.customHeaders && config.customHeaders.length > 0) {\n      config.customHeaders.forEach(header => {\n        const regex = new RegExp(header.match);\n\n        if (regex.test(filepath)) {\n          log.debug(`setting header: ${header.name} for: ${filepath}`);\n          response.setHeader(header.name, header.value);\n        }\n      });\n    }\n\n    if (content && !doNotCache) {\n      log.debug(`serving (cached): ${filepath}`);\n      response.setHeader('Content-Type', mime.getType(filepath, 'text/plain'));\n      responseData = transform && transform(content) || content;\n      response.writeHead(rangeHeader ? convertForRangeRequest() : 200);\n      return response.end(responseData);\n    }\n\n    return fs.readFile(filepath, function (error, data) {\n      if (error) {\n        return serve404(response, filepath);\n      }\n\n      if (!doNotCache) {\n        cache[filepath] = data.toString();\n      }\n\n      log.debug('serving: ' + filepath);\n      response.setHeader('Content-Type', mime.getType(filepath, 'text/plain'));\n      responseData = transform && transform(data.toString()) || data;\n      response.writeHead(rangeHeader ? convertForRangeRequest() : 200);\n      return response.end(responseData);\n    });\n  };\n}\n\nfunction serve404(response, path) {\n  log.warn(`404: ${path}`);\n  response.writeHead(404);\n  return response.end('NOT FOUND');\n}\n\nfunction setNoCacheHeaders(response) {\n  response.setHeader('Cache-Control', 'no-cache');\n  response.setHeader('Pragma', 'no-cache');\n  response.setHeader('Expires', new Date(0).toUTCString());\n}\n\nfunction setHeavyCacheHeaders(response) {\n  response.setHeader('Cache-Control', 'public, max-age=31536000');\n} // PUBLIC API\n\n\nexports.createServeFile = createServeFile;\nexports.setNoCacheHeaders = setNoCacheHeaders;\nexports.setHeavyCacheHeaders = setHeavyCacheHeaders;\nexports.serve404 = serve404;","map":{"version":3,"names":["mime","require","parseRange","log","create","createServeFile","fs","directory","config","cache","Object","filepath","rangeHeader","response","transform","content","doNotCache","responseData","convertForRangeRequest","range","length","Buffer","alloc","type","from","start","end","setHeader","slice","customHeaders","forEach","header","regex","RegExp","match","test","debug","name","value","getType","writeHead","readFile","error","data","serve404","toString","path","warn","setNoCacheHeaders","Date","toUTCString","setHeavyCacheHeaders","exports"],"sources":["/Users/deliabarbuta/Documents/An4Sem1/PAW/Proiect/proiect-paw-tadam/Frontend_OceanCross/node_modules/karma/lib/middleware/common.js"],"sourcesContent":["/**\n * This module contains some common helpers shared between middlewares\n */\n'use strict'\n\nconst mime = require('mime')\nconst parseRange = require('range-parser')\nconst log = require('../logger').create('web-server')\n\nfunction createServeFile (fs, directory, config) {\n  const cache = Object.create(null)\n\n  return function (filepath, rangeHeader, response, transform, content, doNotCache) {\n    let responseData\n\n    function convertForRangeRequest () {\n      const range = parseRange(responseData.length, rangeHeader)\n      if (range === -2) {\n        return 200 // malformed header string\n      } else if (range === -1) {\n        responseData = Buffer.alloc(0) // unsatisfiable range\n        return 416\n      } else if (range.type === 'bytes') {\n        responseData = Buffer.from(responseData)\n        if (range.length === 1) {\n          const { start, end } = range[0]\n          response.setHeader('Content-Range', `bytes ${start}-${end}/${responseData.length}`)\n          response.setHeader('Accept-Ranges', 'bytes')\n          response.setHeader('Content-Length', end - start + 1)\n          responseData = responseData.slice(start, end + 1)\n          return 206\n        } else {\n          responseData = Buffer.alloc(0) // Multiple ranges are not supported. Maybe future?\n          return 416\n        }\n      }\n      return 200 // All other states, ignore\n    }\n\n    if (directory) {\n      filepath = directory + filepath\n    }\n\n    if (!content && cache[filepath]) {\n      content = cache[filepath]\n    }\n\n    if (config && config.customHeaders && config.customHeaders.length > 0) {\n      config.customHeaders.forEach((header) => {\n        const regex = new RegExp(header.match)\n        if (regex.test(filepath)) {\n          log.debug(`setting header: ${header.name} for: ${filepath}`)\n          response.setHeader(header.name, header.value)\n        }\n      })\n    }\n\n    if (content && !doNotCache) {\n      log.debug(`serving (cached): ${filepath}`)\n      response.setHeader('Content-Type', mime.getType(filepath, 'text/plain'))\n      responseData = (transform && transform(content)) || content\n      response.writeHead(rangeHeader ? convertForRangeRequest() : 200)\n      return response.end(responseData)\n    }\n\n    return fs.readFile(filepath, function (error, data) {\n      if (error) {\n        return serve404(response, filepath)\n      }\n\n      if (!doNotCache) {\n        cache[filepath] = data.toString()\n      }\n\n      log.debug('serving: ' + filepath)\n      response.setHeader('Content-Type', mime.getType(filepath, 'text/plain'))\n      responseData = (transform && transform(data.toString())) || data\n      response.writeHead(rangeHeader ? convertForRangeRequest() : 200)\n\n      return response.end(responseData)\n    })\n  }\n}\n\nfunction serve404 (response, path) {\n  log.warn(`404: ${path}`)\n  response.writeHead(404)\n  return response.end('NOT FOUND')\n}\n\nfunction setNoCacheHeaders (response) {\n  response.setHeader('Cache-Control', 'no-cache')\n  response.setHeader('Pragma', 'no-cache')\n  response.setHeader('Expires', (new Date(0)).toUTCString())\n}\n\nfunction setHeavyCacheHeaders (response) {\n  response.setHeader('Cache-Control', 'public, max-age=31536000')\n}\n\n// PUBLIC API\nexports.createServeFile = createServeFile\nexports.setNoCacheHeaders = setNoCacheHeaders\nexports.setHeavyCacheHeaders = setHeavyCacheHeaders\nexports.serve404 = serve404\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}